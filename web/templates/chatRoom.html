<!DOCTYPE  html>
<html lang="en" ng-app="myInject">
<head>
    {{template "header" .}}
    <style>
        body { padding-top: 60px; }
    </style>
    <script>
        var myInject = angular.module("myInject",[]);
        myInject.controller("ChatController", ["$scope", function($scope) {
            var socket = null;
            var wsuri = "ws://" + location.host + location.pathname + "ws";
            var uuid = Date.now().toString();
            $scope.messages = [];
            $scope.roster = [];
            $scope.name = '';
            $scope.text = '';

            socket = new WebSocket(wsuri);
            socket.onopen = function () {
                $scope.setName();//用来注册
            };
            window.onunload = function (ev) {
                socket.send(JSON.stringify({"Method":"Logout","uuid":uuid,"Data": ""}));
            };
            socket.onclose = function (ev) {
                //socket.send(JSON.stringify({"Method":"Logout","uuid":uuid,"Data": ""}));
            };
            socket.onmessage = function (ev) {
                console.log("message receiver:" + ev.data);
                //处理服务端消息
                var m = JSON.parse(ev.data);
                switch (m.Method){
                    case "ClientUpdate":
                        $scope.roster = JSON.parse(ev.data).Data;
                        $scope.$apply();
                        break;
                    case "BroadcoastMsg":
                        $scope.messages.push(JSON.parse(ev.data).Data);
                        $scope.$apply();
                        break;
                }

                // $scope.$apply();
            };

            $scope.send = function send() {
                console.log('Sending message:', $scope.text);
                socket.send(JSON.stringify({"Method":"sendMsg","uuid":uuid,"Data": {"UserName":$scope.name,"Message": $scope.text}}));
                $scope.text = '';
            };

            $scope.setName = function setName() {
                socket.send(JSON.stringify({"Method":"setName","uuid":uuid,"Data": $scope.name}));
            };
        }])
    </script>
</head>
<body>
<div class="container" ng-controller="ChatController">
    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="pull-right">
                <a href="https://c9.io" class="brand">CSS From Cloud9</a>
            </div>
        </div>
    </div>
    <div class="page-header">
        <h1>Chat Example</h1>
    </div>
    <div class="row">
        <div class="span3">
            <ul class="nav nav-list well">
                <li class="nav-header">Local Users</li>
                <li ng-repeat="user in roster" ng-bind="user.UserName">
                </li>
            </ul>
        </div>
        <div class="span9">
            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th class="span2">Name</th>
                    <th class="span7">Text</th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="msg in messages">
                    <td class="span2" ng-bind="msg.UserName"></td>
                    <td class="span7" ng-bind="msg.Message"></td>
                </tr>
                </tbody>
            </table>
            <div class="row controls">
                <form ng-submit="send()">
                    <div class="span2"><input type="text" class="input-block-level" ng-model="name" ng-change="setName()" placeholder="Your Name"></div>
                    <div class="input-append span7">
                        <input type="text" class="span6" ng-model="text" placeholder="Message">
                        <input type="submit" class="span1 btn btn-primary" value="Send" ng-disabled="!text">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{{template "footer" .}}
</body>
</html>